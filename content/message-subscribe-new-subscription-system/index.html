<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        
    

<title>Message-subscribe - A New Subscription System</title>

        <meta name="description" content="">
        <meta name="keywords" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

      <!-- Favicon for all platforms -->
      <link rel="apple-touch-icon" sizes="180x180" href="/images/favicons/apple-touch-icon-180x180.4fe6.png">
      <link rel="icon" type="image/png" href="/images/favicons/favicon-32x32.c391.png" sizes="32x32">
      <link rel="icon" type="image/png" href="/images/favicons/favicon-194x194.2d07.png" sizes="194x194">
      <link rel="icon" type="image/png" href="/images/favicons/favicon-96x96.8557.png" sizes="96x96">
      <link rel="icon" type="image/png" href="/images/favicons/android-chrome-192x192.8b66.png" sizes="192x192">
      <link rel="icon" type="image/png" href="/images/favicons/favicon-16x16.a93c.png" sizes="16x16">
      <link rel="manifest" href="/images/favicons/manifest.json">
      <meta name="msapplication-TileColor" content="#000000">
      <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
      <meta name="theme-color" content="#ffffff">
      <!-- End favicon for all platforms -->

      <link rel="stylesheet" href="/css/main.e76f.css"/>
      <link href='http://fonts.googleapis.com/css?family=Abril+Fatface&text=gizra' rel='stylesheet' type='text/css'>
      <link href='https://fonts.googleapis.com/css?family=Hind:400,600,300,500' rel='stylesheet' type='text/css'>
      <link href='https://fonts.googleapis.com/css?family=Raleway:400,300,600,800' rel='stylesheet' type='text/css'>
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
      <!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-6558346-3', 'auto');
  ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


      <!-- Begin Inspectlet Embed Code -->
      <script type="text/javascript" id="inspectletjs">
      window.__insp = window.__insp || [];
      __insp.push(['wid', 314054580]);
      (function() {
      function ldinsp(){if(typeof window.__inspld != "undefined") return; window.__inspld = 1; var insp = document.createElement('script'); insp.type = 'text/javascript'; insp.async = true; insp.id = "inspsync"; insp.src = ('https:' == document.location.protocol ? 'https' : 'http') + '://cdn.inspectlet.com/inspectlet.js'; var x = document.getElementsByTagName('script')[0]; x.parentNode.insertBefore(insp, x); };
      setTimeout(ldinsp, 500); document.readyState != "complete" ? (window.attachEvent ? window.attachEvent('onload', ldinsp) : window.addEventListener('load', ldinsp, false)) : ldinsp();
      })();
      </script>
      <!-- End Inspectlet Embed Code -->

    </head>
    <body>

    <!-- Main content -->
    
  



  
    
      
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


<div id="post-page">
  <header id="header-post">
    <div class="container">
      <div class="row">
        <div class="col-sm-12">
          
  

<span class="gizra-logo"><a href="/">gizra</a></span>
<nav id="nav" role="navigation" class="navbar navbar-default">
  <div class="navbar-header">
    <button data-target=".navbar-collapse" data-toggle="collapse" class="navbar-toggle" type="button">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
  </div>
  <div class="navbar-collapse collapse">
    <ul class="nav navbar-nav">
      <li><a href="/#about" class="smooth-scroll-to">About Us</a></li>
      <li><a href="/services">Our Work</a></li>
      <li><a href="/team">Meet the Team</a></li>
      <li><a href="/blog">Blog</a></li>
      <li><a href="/contact">Contact</a></li>
    </ul>
  </div>
</nav>

        </div>
      </div>
    </div>
  </header>
  <article class="post">
    <div class="container">
      <div class="row">
        <div class="col-sm-10 col-sm-offset-1 post-title">
          <h1><a href="/content/message-subscribe-new-subscription-system/">Message-subscribe - A New Subscription System </a></h1>
          <div class="post-author">By Amitai Burstein</div>
        </div>
      </div>
      <div class="row">
        <div class="col-sm-2 col-sm-offset-1 post-data">
    			<div id="post-label">
    		 		<a href="/blog"><span class="label label-default">Gizra Blog</span></a>
    			</div>
          <div class="date">31 Oct 2012</div>
          <section class="author-details">
            <div class="image-wrapper">
              <img src="/images/team/avatars/amitaibu.a340.jpg" class="img-circle img-responsive">
            </div>
            <div class="text-wrapper">
              <span class="name">Amitai Burstein</span>
              
                <span class="twitter">(@amitaibu)</span>
              
              <div class="title">CTO, Co-Owner</div>
              <div class="bio">Maintainer of Organic groups, the Message stack, and co-maintainer of Drupal 8's Entity reference. <a href="/content/the-about-story/">The about story</a>.</div>
            </div>
          </section>
          <div class="tags">
            <div class="title">Tags:</div>
            
              <ul class="inline">
                
                

  
    
      <li><a href="/tags.html#Drupal-planet-ref">Drupal-planet</a></li>
    
      <li><a href="/tags.html#Message-ref">Message</a></li>
    
  


              </ul>
            
          </div>
        </div>
        <div class="col-sm-8">
          <div class="post-content">

              <blockquote>
<p>Drupal 6 had Messaging &amp; Notification
Drupal 7 has Message-subscribe &amp; Message-notify</p>
</blockquote>

<p><a href="http://drupal.org/project/message_subscribe">Message-subscribe</a> is a new module in the Message stack, that finally ties everything together to give us the ability to subscribe to content, and send notifications.</p>

<p>If you know Message you already know that some development skills, or knowing Rules really really good are needed. This post will go over the main concepts and flow of the notification process.</p>

<p>Message-subscribe, just like Message module has zero knowledge about your business logic - it is up to you to implement the Message creation. What Message subscribe gives you, though, is one simple function your implementing module will call &ndash; and that’s it. It will take care of it from there.</p>

<!-- more -->

<p>For example imagine an existing node, that people in the site want to subscribe to, and get notified about new comments.</p>

<h3>Subscribing to content</h3>

<p>Subscribing is naturally done using Flag module. There’s no assumption related to the amount of Flags you have - as long as you prefix your flag name with <code>subscribe_</code> Message-subscribe treats it as a valid flag.</p>

<h3>Message creation</h3>
<div class="highlight"><pre><code class="php language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="sd">/**</span>
<span class="sd"> * Implements hook_comment_insert().</span>
<span class="sd"> *</span>
<span class="sd"> * Send a message when a new comment is created to subscribed users.</span>
<span class="sd"> */</span>
<span class="k">function</span> <span class="nf">foo_example_comment_insert</span><span class="p">(</span><span class="nv">$comment</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Create a new message, assigned to the node author, and add a</span>
  <span class="c1">// reference to the comment, so we can later use tokens related to that</span>
  <span class="c1">// comment.</span>
  <span class="nv">$message</span> <span class="o">=</span> <span class="nx">message_create</span><span class="p">(</span><span class="s1">&#39;comment_insert&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;uid&#39;</span> <span class="o">=&gt;</span> <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">uid</span><span class="p">));</span>
  <span class="nv">$wrapper</span> <span class="o">=</span> <span class="nx">entity_metadata_wrapper</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span>
  <span class="c1">// There will be probably a reference field to the comment on the message itself.</span>
  <span class="nv">$wrapper</span><span class="o">-&gt;</span><span class="na">field_comment_ref</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="nv">$comment</span><span class="p">);</span>

  <span class="c1">// Let Message-subscribe save and send notifications.</span>
  <span class="nx">message_subscribe_send_message</span><span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="nv">$comment</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>As seen in the above code, our module created the Message it wanted and passed it along to <code>message_subscribe_send_message()</code>. Let’s see what happens from there.</p>

<h3>Getting “context”</h3>

<p>Drupal abuses the word context with so many meanings. Admittedly Message-subscribe is now also guilty. <code>message_subscribe_get_basic_context()</code> gets the entity type, in our case the comment, and extracts the related context &ndash; the comment author, the node its related to, the taxonomy terms related to the node, the OG groups related to those nodes (you can add our own context as-well).
This context will help us in finding all the users that are subscribed directly or _indirectly to our node.</p>

<h3>Getting the subscribers</h3>

<p>Next, Message-subscribe queries the valid flags, iterating over the results to get all the users that are subscribed. An alter hook allows you to change the list, or the values in that list. The values are which flags are responsible for the subscription and the “Message notifiers” (about that in the next section).</p>

<h3>Sending notifications</h3>

<p>Before we talk about sending notifications, note that I never wrote the word “email”. Message-notify is a pluggable module, that allows you to add “Message-notifiers”. There’s a default implementation for email, but you are also able to add Text-messages, IRC, Fax or Postal-pigeons.</p>

<p>So, Message-subscribe iterates over all the users, and all over the notifiers, as in fact a user can get the same Message as email _and as a Text-message. I say same _Message as in same Message entity, not same message as message text &ndash; In Message-notify you can have different text for different notifiers thanks to the module’s integration with view-modes.</p>

<h3>Bonus</h3>

<ul>
<li>There’s a UI! We are showing tabs for every valid flag, and the content of that tab is a View. You can easily change the used View via admin settings <img src="http://drupal.org/files/project-images/message-subscribe.jpg" width="640" height ="214" /></li>
<li>It’s a Message entity, right? So it means that the email you’ve just sent, can be saved and be used for an activity stream. 2 for the price of 1</li>
<li>For a scalable solution, we are currently working - with a great help from fubhy - on implementing some sort of DrupalQueue to be able to process lots of Messages</li>
</ul>


          </div>
        </div>
      </div>
    </div>
  </article>
    
  <section class="post-nav">
    <div class="container">
      <div class="row">
        <div class="col-xs-4 col-xs-offset-3 previous">
          
          <a href="/content/drupalcamp-montreal-keynote/">
            <div class="previous-label">
              <i class="fa fa-chevron-circle-left"></i>
              Previous<span class="visible-xs"> post</span><span class="hidden-xs">: DrupalCamp Montreal Keynote</span>
            </div>
          </a>
          
        </div>
        <div class="col-xs-4 next">
          
          <a href="/content/drupal-nodejs-pantheon-and-heroku/">
            <div class="next-label">
              Next<span class="visible-xs"> post</span><span class="hidden-xs">: Drupal, Node.js, Pantheon, and Heroku</span>
              <i class="fa fa-chevron-circle-right"></i>
            </div>
          </a>
          
        </div>
      </div>
    </section>
    <section>
      <div class="container">
        <div class="row">
          <div class="col-sm-8 col-sm-offset-3">
            <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'gizra';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

          </div>
        </div>
      </div>
    </section>
  </div>
</div>


    <!--Footer -->
    
  <div id="contact">
    <footer id="footer">
      <div class="footer-wrapper">
        <div class="background">
          <div class="container">
            <div class="row">
              <div class="col-sm-12">
                <h2 class="title">Talk to us</h2>
                <div class="clearfix">
                  <address>
                    <div class="strong">Israel Headquarters</div>
                    <span>5 Brenner Street, Tel Aviv</span>
                      <a class="telephone" href="tel:+97233731222">+972-3-3731222</a>
                    <a class="email" href="mailto:info@gizra.com">info@gizra.com</a>
                  </address>
                  <address class="separator">
                    <div class="strong">North America Office</div>
                    <span>106 West 32nd Street, 2nd Floor, New York, NY 10008</span>
                    <a class="telephone" href="tel:+13476864508">347-686-4508</a>
                    <a class="email" href="mailto:usoffice@gizra.com">usoffice@gizra.com</a>
                  </address>
                  <div class="separator social-links">
                    <span class="link github">
                      <a href="https://github.com/Gizra" target="_blank" title="Gizra's Github Account"><i class="fa fa-github-square"></i></a>
                    </span>
                    <span class="link twitter">
                      <a href="https://twitter.com/gizra_drupal" target="_blank" title="Gizra's Twitter Account"><i class="fa fa-twitter-square"></i></a>
                    </span>
                    <span class="link linkedin">
                      <a href="https://www.linkedin.com/company/gizra-ltd" target="_blank" title="Gizra's LinkedIn Page"><i class="fa fa-linkedin-square"></i></a>
                    </span>
                    <span class="link facebook">
                      <a href="https://www.facebook.com/gizraltd/timeline" target="_blank" title="Gizra's Facebook Page"><i class="fa fa-facebook-square"></i></a>
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </footer>
  </div>



    <script src="/js/plugins.f180.js"></script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery-backstretch/2.0.4/jquery.backstretch.min.js"></script>

    <script src="/js/scripts.1fc2.js"></script>
    </body>
</html>
